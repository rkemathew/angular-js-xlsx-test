<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Angular Js XLS</title>
</head>

<body ng-app="app">
    <div ng-controller="MainCtrl" style="margin: 30px;">
        <!-- <input type="file" id="upload" name="upload" import-sheet-js="" /> -->
        <input type="file" id="upload" name="upload" style="visibility: hidden; width: 1px; height: 1px" import-sheet-js="" />
        <a href="" onclick="document.getElementById('upload').click(); return false">Upload</a>

        <div style="border: dotted 3px lightgray; width: 100px; height: 100px; margin-top: 30px" nv-file-drop="" uploader="uploader">
            Drop Files Here
        </div>
    </div>

    <script type="text/javascript" src="../bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="../bower_components/angular/angular.min.js"></script>
    <script type="text/javascript" src="../bower_components/js-xlsx/dist/xlsx.full.min.js"></script>
    <script type="text/javascript" src="../bower_components/angular-file-upload/dist/angular-file-upload.min.js"></script>
    <script type="text/javascript">
        /* RM: FileReader Shim for readAsBinaryString neededor IE Begins */
        if (FileReader.prototype.readAsBinaryString === undefined) {
            FileReader.prototype.readAsBinaryString = function (fileData) {
                var binary = "";
                var pt = this;
                var reader = new FileReader();
                reader.onload = function (e) {
                    var bytes = new Uint8Array(reader.result);
                    var length = bytes.byteLength;
                    for (var i = 0; i < length; i++) {
                        binary += String.fromCharCode(bytes[i]);
                    }
                    //pt.result  - readonly so assign content to another property
                    pt.content = binary;
                    pt.onload(); // thanks to @Denis comment
                }
                reader.readAsArrayBuffer(fileData);
            }
        }
        /* RM: FileReader Shim for readAsBinaryString needed for IE Ends */

        /* RM: Determining if browser is IE */
        var isIE = false;
        if (navigator.appName == 'Microsoft Internet Explorer' ||  !!(navigator.userAgent.match(/Trident/) || navigator.userAgent.match(/rv:11/)) || (typeof $.browser !== "undefined" && $.browser.msie == 1)) {
            isIE = true;
        }

        /* RM: Angular Code starts here */
        var app = angular.module('app', [ 'angularFileUpload' ]);
        
        app.directive('importSheetJs', function() {
            return {
                scope: { },
                link: function ($scope, $elm, $attrs) {
                    $elm.on('change', function (changeEvent) {
                        $scope.$emit('file:uploaded', changeEvent.target.files[0])
                    });
                }
            };
        });

        app.controller('MainCtrl', ['$scope', '$q', 'FileUploader', function ($scope, $q, FileUploader) {
            var uploader = $scope.uploader = new FileUploader({});
            uploader.onAfterAddingFile = function(fileItem) {
                processXlsx(fileItem._file);
            };

            $scope.$on('file:uploaded', function(event, file) {
                processXlsx(file);
            });

            /* RM: the following two functions are not specific to Angular and so could be used within node as well */
            function processXlsx(file) {
                readXlsx(file).then(function(workbook) {
                    console.log('workbook', workbook);
                    // RM: All processing of the workbook happens here...
                    var eeDataSheetName = 'Employee Data Requirements';
                    var worksheet = workbook.Sheets[eeDataSheetName];

                    var countryCellAddr = 'B8';
                    var currencyCellAddr = 'C8';
                    var revenueCellAddr = 'D8';
                    var industrySectorCellAddr = 'E8';
                    var numEesCellAddr = 'F8';
                    var eeJobTitleCellAddr = 'G8';
                    var eeGradeCellAddr = 'H8';
                    var eeIdCellAddr = 'I8';

                    var country = (worksheet[countryCellAddr] ? worksheet[countryCellAddr].v : undefined);
                    var currency = (worksheet[currencyCellAddr] ? worksheet[currencyCellAddr].v : undefined);
                    var revenue = (worksheet[revenueCellAddr] ? worksheet[revenueCellAddr].v : undefined);
                    var industrySector = (worksheet[industrySectorCellAddr] ? worksheet[industrySectorCellAddr].v : undefined);
                    var numEes = (worksheet[numEesCellAddr] ? worksheet[numEesCellAddr].v : undefined);
                    var eeJobTitle = (worksheet[eeJobTitleCellAddr] ? worksheet[eeJobTitleCellAddr].v : undefined);
                    var eeGrade = (worksheet[eeGradeCellAddr] ? worksheet[eeGradeCellAddr].v : undefined);
                    var eeId = (worksheet[eeIdCellAddr] ? worksheet[eeIdCellAddr].v : undefined);

                    console.log('country', country);
                    console.log('currency', currency);
                    console.log('revenue', revenue);
                    console.log('industrySector', industrySector);
                    console.log('numEes', numEes);
                    console.log('eeJobTitle', eeJobTitle);
                    console.log('eeGrade', eeGrade);
                    console.log('eeId', eeId);

                    //Use Sheet to JSON to get a JSON representation of the worksheet
                     var eeDataSheetJSON = XLSX.utils.sheet_to_json(worksheet, { range: "A" });
                     console.log('eeDataSheetJSON', eeDataSheetJSON);
                });
            }

            function readXlsx(file) {
                // RM: You could replace the promise returned by $q with native promises if using this in node
                var def = $q.defer();
                var reader = new FileReader();
                
                reader.onload = function (e) {
                    var bstr = null;
                    if (isIE) { // RM: This check is not needed if using this in node
                        bstr = reader.content;
                    } else {
                        bstr = reader.result;
                    }

                    var workbook = XLSX.read(bstr, {type:'binary'});
                    def.resolve(workbook);
                };

                reader.readAsBinaryString(file);

                return def.promise;
            }
        }]);
        /* RM: Angular code ends here */
    </script>
</body>

</html>
